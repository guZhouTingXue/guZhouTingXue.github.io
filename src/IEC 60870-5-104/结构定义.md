---
category: IEC 60870-5-104
---
# 结构定义
从原始报文到界面显示
定义存储显示数据的结构
<!-- more -->

## APCI
``` mermaid
classDiagram
	class APCI {
		<<Abstract>>
		Type type
		uint8_t char[6] buffer
		virtual QString display() = 0;
	}
```
m_type: APCI的类型
buffer：原始数据
display(): 显示的内容
APCI 是抽象类，它本身没有含义，不能直接定义APCI 对象

注意：
1. 数组类型
使用char 计算序列号
``` cpp
	char a = 0x80;
	char b = 0x00;
	size_t s = (a + b * 0x100) / 2;
	cout << s << endl;
```
输出：
``` 
18446744073709551552
```
char 是有符号数，最高位表示符号位-1为负数。
a 的值 为-128。对s 赋值时左侧表达式为 char 类型，值为-64，最高位为1.转换为size_t 后就是一个很大的数了。
处理报文中的字节数时，使用unsigned char。库中使用uint8_t。

2. 纯虚函数不能在类内定义：派生类对象调用纯虚函数，或 通过抽象类的引用


``` mermaid
classDiagram
	class APCI { <<Abstract>> }
	class I {
		I(char *b)
		size_t recvSequenceNumber
		size_t sendSequenceNumber
	}
	I --> APCI
	class U {
		U(char *b)
		Type type
	}
	U --> APCI
	class S {
		S(char *b)
		size_t recvSequenceNumber
	}
	S --> APCI
```
recvSequenceNumber: 接收序列号
sendSequenceNumber: 发送序列号
Type： U帧报文类型
在构造函数中设置原始报文并解析数据



## ASDU
``` mermaid
classDiagram
	class ASDU { <<Abstract>> 
		uint8_t *buffer
		TypeId type;
		VSQ variableStructureQualifier;
		COT causeOfTransimission;
		Addr addr;
		List<InformationElement> elements;
		AppLayerParameters parameters;
		void addElement(InformationElement);
		void setElements(List<Information>)
	}
	class VSQ {
		SQ sequence;
		NumIx numberIndex;
	}
	class COT {
		Test test;
		Negative negative;
		CauseTx cause;
		OA originatorAddress;
	}
	class InformationElement {
		IOA informationObjectAddress;
		
	}
```
结构定义包含可选项，如COT中的OA，在配置参数中获取是否包含可选项，如果包含再获取可选项的值。

