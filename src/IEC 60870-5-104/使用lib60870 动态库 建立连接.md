---
category: IEC 60870-5-104
---


# 使用lib60870 动态库 建立连接
使用开源的C 实现的动态库 建立连接
<!-- more -->
下载：
[IEC 60870-5-101/104 C Code Library IEC 104 | MZ Automation](https://www.mz-automation.de/iec60870-5-101-iec-104-c-code-library/)


## 编译动态库
1. 下载最新版本源代码
2. 按源代码中的README提示进行编译，在CMakeLists.txt路径下：
	1. 创建并进入构建目录：mkdir build; cd build
	2. 构建：cmake ..
构建成功：
![](./attachments/使用lib60870%20动态库%20建立连接.webp)
3. 编译：进入build，打开sln。菜单栏 build-》build solution
编译成功：
![](./attachments/使用lib60870%20动态库%20建立连接-1.webp)
4. dll路径在：\lib60870-2.3.2\lib60870-2.3.2\lib60870-C\build\src\Debug\
![](./attachments/使用lib60870%20动态库%20建立连接-2.webp)

## 使用动态库
1. 在qt工程路径下添加一个路径（lib）作为dll存放路径，然后拷贝前面生成的dll到该路径下
2. 再添加一个路径（includes）作为头文件存放路径，然后将以下两个头文件夹拷贝到includes下
	1. scr/inc/api
	2. scr/hal/inc
3. 修改CMakeLists.txt，添加链接的库 和 使用的头文件路径
``` cmake title="CMakeLists.txt"
target_include_directories(appIEC60870_5_104_TestTool
    PRIVATE ${PROJECT_SOURCE_DIR}/includes/inc/api
    ${PROJECT_SOURCE_DIR}/includes/hal/inc

)

target_link_libraries(appIEC60870_5_104_TestTool
    PRIVATE Qt6::Quick
    ${PROJECT_SOURCE_DIR}/lib/lib60870.dll
)
```
4. 把examples/cs_104Client/simple_client.c 中的内容拷贝到main.cpp下
5. 运行程序，输出以下信息：
``` txt
Connecting to: localhost:2404
Failed to connect
Connect failed!
exit
```
说明动态库调用正常
6. 在visual studio中运行server
	1. 右键选中cs104_server，然后点击set as Startup Project，将其作为启动项目
	![](./attachments/使用lib60870%20动态库%20建立连接-3.webp)
	2. 拷贝dll到  lib60870-C\build\examples\cs104_server\Debug下
		如果没有拷贝会报错：
	![|389x166](./attachments/使用lib60870%20动态库%20建立连接-5.webp)
	3. 运行项目：点击绿色启动按钮
![](./attachments/使用lib60870%20动态库%20建立连接-4.webp)


7. 启动client
输出以下信息：
``` txt
Connecting to: localhost:2404
Connection established
Connected!
Received STARTDT_CON
RECVD ASDU type: M_ME_NB_1(11) elements: 1
RECVD ASDU type: M_ME_NB_1(11) elements: 1
RECVD ASDU type: M_ME_NB_1(11) elements: 1
```
	连接成功并接收到ASDU
