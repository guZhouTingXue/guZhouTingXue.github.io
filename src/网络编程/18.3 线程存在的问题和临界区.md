---
category: 网络编程
---
# 18.3 线程存在的问题和临界区
多个线程同时访问同一块内存（不限于全局变量）时存在的问题
修改一个变量的过程：
1. 读变量的值并传递给CPU
2. CPU计算结果
3. 将结果写回变量

线程的切换可能发生在以上三个阶段中的任意一个。
假设num当前值为99
``` mermaid
flowchart 
num-99@{shape: text, label: "99"}
subgraph thread0["inc"]
 read0@{ shape: rect, label: "read 99" }
 inc@{ shape: rect, label: "inc 100"}
 write0@{ shape: rect, label: "write 100"}
 read0 --> inc -.-> write0
end

subgraph thread1["des"]
 read1@{ shape: rect, label: "read 99" }
 des@{ shape: rect, label: "des 98"}
 write1@{ shape: rect, label: "write 98"}
 read1 --> des --> write1
end

num-99 --> |执行|thread0 
inc -->|切换线程| thread1
num-99 --> thread1
write1 --> num98 --> write0 --> num100

```
执行1次+1 和 一次 -1 操作后num的值应该保持不变。但是在上面的情景中，inc线程写入前切换到des线程，此时des读取到的num值是99，不管des对num如何操作，切换回inc后最终num的值都是100.

问题的原因：对num修改的操作分多步进行，可能因为切换线程被打断，导致数据没有更新完成。切换后使用的是更新前的数据。
