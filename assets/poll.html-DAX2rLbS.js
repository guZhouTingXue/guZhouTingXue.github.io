import{_ as h}from"./plugin-vue_export-helper-DlAUqK2U.js";import{c as p,a as s,b as d,d as e,f as t,w as l,e as n,r as k,o as r}from"./app-DfW-2e5v.js";const A="/assets/poll-B5jswlgY.webp",c="data:image/webp;base64,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",o="/assets/poll-3-Ba_fdqZj.webp",g={};function y(v,i){const a=k("font");return r(),p("div",null,[i[13]||(i[13]=s("h1",{id:"poll",tabindex:"-1"},[s("a",{class:"header-anchor",href:"#poll"},[s("span",null,"poll")])],-1)),i[14]||(i[14]=s("div",{class:"hint-container info"},[s("p",{class:"hint-container-title"},"相关信息"),s("p",null,"poll() performs a similar task to select(2): it waits for one of a set of file descriptors to become ready to perform I/O.")],-1)),d("more"),i[15]||(i[15]=e(`<div class="language-cpp line-numbers-mode" data-highlighter="shiki" data-ext="cpp" style="--shiki-light:#383A42;--shiki-dark:#abb2bf;--shiki-light-bg:#FAFAFA;--shiki-dark-bg:#282c34;"><pre class="shiki shiki-themes one-light one-dark-pro vp-code"><code class="language-cpp"><span class="line"></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">NAME</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">       poll, ppoll </span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">-</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> wait </span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">for</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> some event on a file descriptor</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">SYNOPSIS</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">       #include</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> &lt;poll.h&gt;</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">       int</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;"> poll</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">(</span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">struct</span><span style="--shiki-light:#C18401;--shiki-dark:#E5C07B;"> pollfd</span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;"> *</span><span style="--shiki-light:#383A42;--shiki-light-font-style:inherit;--shiki-dark:#E06C75;--shiki-dark-font-style:italic;">fds</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">, </span><span style="--shiki-light:#0184BC;--shiki-dark:#56B6C2;">nfds_t</span><span style="--shiki-light:#383A42;--shiki-light-font-style:inherit;--shiki-dark:#E06C75;--shiki-dark-font-style:italic;"> nfds</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">, </span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">int</span><span style="--shiki-light:#383A42;--shiki-light-font-style:inherit;--shiki-dark:#E06C75;--shiki-dark-font-style:italic;"> timeout</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">);</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><table><thead><tr><th>参数</th><th>值</th><th>用途</th><th>说明</th></tr></thead><tbody><tr><td>fds</td><td></td><td>The set of file descriptors to be monitored is specified in the fds argument, which is an array of structures</td><td>存储要监视的fd结构体数组</td></tr><tr><td>nfds</td><td></td><td>the number of items in the fds array</td><td>数组内元素的数量</td></tr><tr><td>timeout</td><td></td><td>the number of milliseconds that poll() should block waiting for a file descriptor to become ready.</td><td>0：立即返回<br>negative value: 一直等待</td></tr><tr><td>RETURN</td><td>&gt; 0; 0; -1</td><td>positive number: the number of structures which have nonzero revents fields (in other words, those descriptors with events or errors reported).<br>0: the call timed out and no file descriptors were ready.<br>-1:error</td><td></td></tr></tbody></table><h2 id="结构体定义" tabindex="-1"><a class="header-anchor" href="#结构体定义"><span>结构体定义</span></a></h2><div class="language-cpp line-numbers-mode" data-highlighter="shiki" data-ext="cpp" style="--shiki-light:#383A42;--shiki-dark:#abb2bf;--shiki-light-bg:#FAFAFA;--shiki-dark-bg:#282c34;"><pre class="shiki shiki-themes one-light one-dark-pro vp-code"><code class="language-cpp"><span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">	  struct</span><span style="--shiki-light:#C18401;--shiki-dark:#E5C07B;"> pollfd</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> {</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">		   int</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">   fd;</span><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;">         /* file descriptor */</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">		   short</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> events;</span><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;">     /* requested events */</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">		   short</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> revents;</span><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;">    /* returned events */</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">	   };</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><table><thead><tr><th>参数</th><th>值</th><th>用途</th><th>说明</th></tr></thead><tbody><tr><td>fd</td><td></td><td>The field fd contains a file descriptor for an open file. If this field is negative, then the corresponding events field is ignored and the revents field returns zero.</td><td>-1 表示没有要监视的对象</td></tr><tr><td>events</td><td>0 或 监视事件的组合</td><td>an input parameter, a bit mask specifying the events the application is interested in for the file descriptor fd. This field may be specified as zero, in which case the only events that can be returned in revents are POLLHUP, POLLERR, and POLLNVAL (see below).</td><td></td></tr><tr><td>revents</td><td></td><td>The field revents is an output parameter, filled by the kernel with the events that actually occurred.</td><td>0表示没有事件发生？</td></tr></tbody></table><h2 id="事件定义" tabindex="-1"><a class="header-anchor" href="#事件定义"><span>事件定义</span></a></h2>`,6)),s("table",null,[i[12]||(i[12]=s("thead",null,[s("tr",null,[s("th",null,"名称"),s("th",null,"含义"),s("th",null,"说明")])],-1)),s("tbody",null,[i[9]||(i[9]=s("tr",null,[s("td",null,"POLLIN"),s("td",null,"There is data to read."),s("td")],-1)),i[10]||(i[10]=s("tr",null,[s("td",null,"POLLOUT"),s("td",null,"Writing is now possible, though a write larger that the available space in a socket or pipe will still block (unless O_NONBLOCK is set)."),s("td")],-1)),s("tr",null,[s("td",null,[t(a,{color:"#f79646"},{default:l(()=>[...i[0]||(i[0]=[n("POLLERR",-1)])]),_:1})]),i[1]||(i[1]=s("td",null,"Error condition (only returned in revents; ignored in events).",-1)),i[2]||(i[2]=s("td",null,"即使不进行监视，发生该错误时仍然会导致poll（）返回",-1))]),s("tr",null,[s("td",null,[t(a,{color:"#f79646"},{default:l(()=>[...i[3]||(i[3]=[n("POLLHUP",-1)])]),_:1})]),i[4]||(i[4]=s("td",null,[n("Hang up"),s("br"),n("Note that when reading from a channel such as a pipe or a stream socket, this event merely indicates that the peer closed its end of the channel. Subsequent reads from the channel will return 0 (end of file) only after all outstanding data in the channel has been consumed.")],-1)),i[5]||(i[5]=s("td",null,"对端关闭时",-1))]),i[11]||(i[11]=s("tr",null,[s("td",null,"POLLRDHUP"),s("td",null,"Stream socket peer closed connection, or shut down writing half of connection."),s("td",null,"流式套接字 - TCP 对端关闭连接 或 半关闭输出时")],-1)),s("tr",null,[s("td",null,[t(a,{color:"#f79646"},{default:l(()=>[...i[6]||(i[6]=[n("POLLNVAL",-1)])]),_:1})]),i[7]||(i[7]=s("td",null,"Invalid request: fd not open",-1)),i[8]||(i[8]=s("td",null,null,-1))])])]),i[16]||(i[16]=e(`<div class="code-block-with-title"><div class="code-block-title-bar" data-title="poll.h"><span>poll.h</span></div><div class="language-cpp line-numbers-mode has-collapsed-lines collapsed" data-highlighter="shiki" data-ext="cpp" style="--vp-collapsed-lines:15;--shiki-light:#383A42;--shiki-dark:#abb2bf;--shiki-light-bg:#FAFAFA;--shiki-dark-bg:#282c34;"><pre class="shiki shiki-themes one-light one-dark-pro vp-code"><code class="language-cpp"><span class="line"><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;">/* Event types that can be polled for.  These bits may be set in \`events&#39;</span></span>
<span class="line"><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;">   to indicate the interesting event types; they will appear in \`revents&#39;</span></span>
<span class="line"><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;">   to indicate the status of the file descriptor.  */</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">#define</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;"> POLLIN</span><span style="--shiki-light:#986801;--shiki-dark:#E06C75;">		0x</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;">001</span><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;">		/* There is data to read.  */</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">#define</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;"> POLLPRI</span><span style="--shiki-light:#986801;--shiki-dark:#E06C75;">		0x</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;">002</span><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;">		/* There is urgent data to read.  */</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">#define</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;"> POLLOUT</span><span style="--shiki-light:#986801;--shiki-dark:#E06C75;">		0x</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;">004</span><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;">		/* Writing now will not block.  */</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">#if</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;"> defined</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;"> __USE_XOPEN</span><span style="--shiki-light:#A626A4;--shiki-dark:#56B6C2;"> ||</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;"> defined</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;"> __USE_XOPEN2K8</span></span>
<span class="line"><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;">/* These values are defined in XPG4.2.  */</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;"># define</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;"> POLLRDNORM</span><span style="--shiki-light:#986801;--shiki-dark:#E06C75;">	0x</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;">040</span><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;">		/* Normal data may be read.  */</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;"># define</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;"> POLLRDBAND</span><span style="--shiki-light:#986801;--shiki-dark:#E06C75;">	0x</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;">080</span><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;">		/* Priority data may be read.  */</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;"># define</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;"> POLLWRNORM</span><span style="--shiki-light:#986801;--shiki-dark:#E06C75;">	0x</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;">100</span><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;">		/* Writing now will not block.  */</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;"># define</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;"> POLLWRBAND</span><span style="--shiki-light:#986801;--shiki-dark:#E06C75;">	0x</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;">200</span><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;">		/* Priority data may be written.  */</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">#endif</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">#ifdef</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;"> __USE_GNU</span></span>
<span class="line"><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;">/* These are extensions for Linux.  */</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;"># define</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;"> POLLMSG</span><span style="--shiki-light:#986801;--shiki-dark:#E06C75;">	0x</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;">400</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;"># define</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;"> POLLREMOVE</span><span style="--shiki-light:#986801;--shiki-dark:#E06C75;">	0x</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;">1000</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;"># define</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;"> POLLRDHUP</span><span style="--shiki-light:#986801;--shiki-dark:#E06C75;">	0x</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;">2000</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">#endif</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;">/* Event types always implicitly polled for.  These bits need not be set in</span></span>
<span class="line"><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;">   \`events&#39;, but they will appear in \`revents&#39; to indicate the status of</span></span>
<span class="line"><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;">   the file descriptor.  */</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">#define</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;"> POLLERR</span><span style="--shiki-light:#986801;--shiki-dark:#E06C75;">		0x</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;">008</span><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;">		/* Error condition.  */</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">#define</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;"> POLLHUP</span><span style="--shiki-light:#986801;--shiki-dark:#E06C75;">		0x</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;">010</span><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;">		/* Hung up.  */</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">#define</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;"> POLLNVAL</span><span style="--shiki-light:#986801;--shiki-dark:#E06C75;">	0x</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;">020</span><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;">		/* Invalid polling request.  */</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div><div class="collapsed-lines"></div></div></div><h2 id="关于-pollhup-和-pollrdhup-的差别" tabindex="-1"><a class="header-anchor" href="#关于-pollhup-和-pollrdhup-的差别"><span>关于 POLLHUP 和 POLLRDHUP 的差别</span></a></h2><table><thead><tr><th>属性</th><th>POLLHUP</th><th>POLLRDHUP</th></tr></thead><tbody><tr><td>fd类型</td><td>pipe、stream socket</td><td>stream socket</td></tr><tr><td>何时</td><td>peer closed its end of the channel</td><td>peer closed connection, or shut down writing half of connection</td></tr></tbody></table><p>测试：<br> 实现：<br><strong>服务端</strong></p><div class="language-cpp line-numbers-mode has-collapsed-lines collapsed" data-highlighter="shiki" data-ext="cpp" style="--vp-collapsed-lines:15;--shiki-light:#383A42;--shiki-dark:#abb2bf;--shiki-light-bg:#FAFAFA;--shiki-dark-bg:#282c34;"><pre class="shiki shiki-themes one-light one-dark-pro has-highlighted vp-code"><code class="language-cpp"><span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">#include</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> &lt;poll.h&gt;</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">int</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;"> main</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">()</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">{</span></span>
<span class="line"><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;">	//... socket、bind、listen</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">	struct</span><span style="--shiki-light:#C18401;--shiki-dark:#E5C07B;"> pollfd</span><span style="--shiki-light:#E45649;--shiki-dark:#E5C07B;"> pfds</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">[</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;">5</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">];</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">	for</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">(</span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">int</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> i</span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">=</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;">0</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">; i</span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">&lt;</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;">5</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">; i</span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">++</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">) {</span></span>
<span class="line"><span style="--shiki-light:#E45649;--shiki-dark:#E5C07B;">	    pfds</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">[i].</span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">fd</span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;"> =</span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;"> -</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;">1</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">;</span></span>
<span class="line"><span style="--shiki-light:#E45649;--shiki-dark:#E5C07B;">	    pfds</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">[i].</span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">events</span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;"> =</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;"> 0</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">;</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">	}</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#E45649;--shiki-dark:#E5C07B;">	pfds</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">[</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;">0</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">].</span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">fd</span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;"> =</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> listen_sock;</span></span>
<span class="line"><span style="--shiki-light:#E45649;--shiki-dark:#E5C07B;">	pfds</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">[</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;">0</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">].</span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">events</span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;"> =</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> POLLIN;</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">	int</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> num_fds </span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">=</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;"> 1</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">;</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">	</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">	for</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> (;;) {</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">		nfds </span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">=</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;"> poll</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">(pfds, </span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;">5</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">, </span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">-</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;">1</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">);</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">	    if</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> (nfds </span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">==</span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;"> -</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;">1</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">) {</span></span>
<span class="line"><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">			perror</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">(</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;">&quot;poll&quot;</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">);</span></span>
<span class="line"><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">		    exit</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">(EXIT_FAILURE);</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">	    }</span></span>
<span class="line"><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">        printf</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">(</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;">&quot;Number of events: </span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;">%d</span><span style="--shiki-light:#0184BC;--shiki-dark:#56B6C2;">\\n</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;">&quot;</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">, nfds);</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">	    for</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> (</span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">int</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> n </span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">=</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;"> 0</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">; n </span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">&lt;</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;"> 5</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">; </span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">++</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">n) {</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">			if</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">(</span><span style="--shiki-light:#E45649;--shiki-dark:#E5C07B;">pfds</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">[n].</span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">fd</span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;"> ==</span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;"> -</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;">1</span><span style="--shiki-light:#A626A4;--shiki-dark:#56B6C2;"> ||</span><span style="--shiki-light:#E45649;--shiki-dark:#E5C07B;"> pfds</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">[n].</span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">revents</span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;"> ==</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;"> 0</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">)</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">				continue</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">;</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">			printf</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">(</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;">&quot;n:</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;">%d</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> event:</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;">%hx</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;">, revents:</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;">%hx</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;">,fd=</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;">%d</span><span style="--shiki-light:#0184BC;--shiki-dark:#56B6C2;">\\n</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;">&quot;</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">, n, </span><span style="--shiki-light:#E45649;--shiki-dark:#E5C07B;">pfds</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">[n].</span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">events</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">, </span><span style="--shiki-light:#E45649;--shiki-dark:#E5C07B;">pfds</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">[n].</span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">revents</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">, </span><span style="--shiki-light:#E45649;--shiki-dark:#E5C07B;">pfds</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">[n].</span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">fd</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">);</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">		    if</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> (</span><span style="--shiki-light:#E45649;--shiki-dark:#E5C07B;">pfds</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">[n].</span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">fd</span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;"> ==</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> listen_sock) {</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">			    conn_sock </span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">=</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;"> accept</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">(listen_sock,</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">							   (</span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">struct</span><span style="--shiki-light:#C18401;--shiki-dark:#E5C07B;"> sockaddr</span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;"> *</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">) </span><span style="--shiki-light:#A626A4;--shiki-dark:#56B6C2;">&amp;</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">clnt_addr, </span><span style="--shiki-light:#A626A4;--shiki-dark:#56B6C2;">&amp;</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">addrlen);</span></span>
<span class="line"><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;">				//...</span></span>
<span class="line"><span style="--shiki-light:#E45649;--shiki-dark:#E5C07B;">			    pfds</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">[num_fds].</span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">fd</span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;"> =</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> conn_sock;</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">				if</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">(eventsType </span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">==</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;"> 0</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">)</span></span>
<span class="line highlighted"><span style="--shiki-light:#E45649;--shiki-dark:#E5C07B;">			    	pfds</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">[num_fds].</span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">events</span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;"> =</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">  POLLHUP;</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">				else</span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;"> if</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">(eventsType </span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">==</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;"> 1</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">)</span></span>
<span class="line"><span style="--shiki-light:#E45649;--shiki-dark:#E5C07B;">					pfds</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">[num_fds].</span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">events</span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;"> =</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">  POLLHUP </span><span style="--shiki-light:#A626A4;--shiki-dark:#56B6C2;">|</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> POLLIN; </span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">				else</span></span>
<span class="line"><span style="--shiki-light:#E45649;--shiki-dark:#E5C07B;">					pfds</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">[num_fds].</span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">events</span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;"> =</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">  POLLHUP </span><span style="--shiki-light:#A626A4;--shiki-dark:#56B6C2;">|</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> POLLIN </span><span style="--shiki-light:#A626A4;--shiki-dark:#56B6C2;">|</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> POLLRDHUP; </span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">			    num_fds</span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">++</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">;</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">		    } </span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">else</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> {</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">                int</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> r </span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">=</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;"> read</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">(</span><span style="--shiki-light:#E45649;--shiki-dark:#E5C07B;">pfds</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">[n].</span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">fd</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">, message, </span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">sizeof</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">(message));</span></span>
<span class="line"><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">				printf</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">(</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;">&quot;Read </span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;">%d</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> bytes from fd:</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;">%d</span><span style="--shiki-light:#0184BC;--shiki-dark:#56B6C2;">\\n</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;">&quot;</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">, r, </span><span style="--shiki-light:#E45649;--shiki-dark:#E5C07B;">pfds</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">[n].</span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">fd</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">);</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">		   }</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">	   }</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">	}</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">    close</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">(listen_sock);</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">	return</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;"> 0</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">;</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">}</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div><div class="collapsed-lines"></div></div><table><thead><tr><th>行号</th><th>功能</th><th>说明</th></tr></thead><tbody><tr><td>6-9</td><td>初始化fd集合</td><td></td></tr><tr><td>11、12</td><td>设置监视监听socket的POLLIN事件</td><td></td></tr><tr><td>24</td><td>遍历整个fd集合</td><td>因为poll和select 一样只返回符合监听条件的对象的数量，而不是具体的对象集合。所以只能遍历整个对象集合，通过fd 以及 revents 判断是哪个<strong>对象</strong> 发生了何种 <strong>事件</strong></td></tr><tr><td>25、26</td><td></td><td>没有对应的监听对象 或 对象没有发生对应的事件时跳过该对象</td></tr><tr><td>30-42</td><td>收到连接请求</td><td>接受连接请求，并将连接的socket 添加到 监听fd集合中</td></tr><tr><td>34-40</td><td>监听 与客户端通信的socket</td><td></td></tr><tr><td>44、45</td><td>读取接收的消息</td><td>客户端连接后会先发送hello，然后再进行shutdown</td></tr></tbody></table><p><strong>客户端</strong></p><div class="language-cpp line-numbers-mode" data-highlighter="shiki" data-ext="cpp" style="--shiki-light:#383A42;--shiki-dark:#abb2bf;--shiki-light-bg:#FAFAFA;--shiki-dark-bg:#282c34;"><pre class="shiki shiki-themes one-light one-dark-pro vp-code"><code class="language-cpp"><span class="line"><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">write</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">(sock, </span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;">&quot;Hello&quot;</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">, </span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;">5</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">);</span></span>
<span class="line"><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">shutdown</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">(sock, SHUT_WR);</span></span>
<span class="line"><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">close</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">(sock);</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>效果：<br> 监视的事件类型：<br> POLLHUP</p><div class="language- line-numbers-mode" data-highlighter="shiki" data-ext="" style="--shiki-light:#383A42;--shiki-dark:#abb2bf;--shiki-light-bg:#FAFAFA;--shiki-dark-bg:#282c34;"><pre class="shiki shiki-themes one-light one-dark-pro vp-code"><code class="language-"><span class="line"><span>ming@ubuntu:/media/sf_share/Network/build$ ./Network 10086</span></span>
<span class="line"><span>Socket created, listen_sock fd:3</span></span>
<span class="line"><span>Number of events: 1</span></span>
<span class="line"><span>n:0 event:1, revents:1,fd=3</span></span>
<span class="line"><span>Connection established with client, client fd:4, ip:192.168.56.101, port:39766</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>服务单会阻塞在poll( )</p><p>POLLHUP | POLLIN</p><div class="language- line-numbers-mode" data-highlighter="shiki" data-ext="" style="--shiki-light:#383A42;--shiki-dark:#abb2bf;--shiki-light-bg:#FAFAFA;--shiki-dark-bg:#282c34;"><pre class="shiki shiki-themes one-light one-dark-pro vp-code"><code class="language-"><span class="line"><span>Socket created, listen_sock fd:3</span></span>
<span class="line"><span>Number of events: 1</span></span>
<span class="line"><span>n:0 event:1, revents:1,fd=3</span></span>
<span class="line"><span>Connection established with client, client fd:4, ip:192.168.56.101, port:39764</span></span>
<span class="line"><span>Number of events: 1</span></span>
<span class="line"><span>n:1 event:11, revents:1,fd=4</span></span>
<span class="line"><span>Read 5 bytes from fd:4</span></span>
<span class="line"><span>Number of events: 1</span></span>
<span class="line"><span>n:1 event:11, revents:1,fd=4</span></span>
<span class="line"><span>Read 0 bytes from fd:4</span></span>
<span class="line"><span>Number of events: 1</span></span>
<span class="line"><span>n:1 event:11, revents:1,fd=4</span></span>
<span class="line"><span>Read 0 bytes from fd:4</span></span>
<span class="line"><span>。。。</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><table><thead><tr><th>行号</th><th>功能</th><th>说明</th></tr></thead><tbody><tr><td>1</td><td></td><td>监听socket的fd为3</td></tr><tr><td>2-4</td><td></td><td>收到连接请求，创建的con_sock fd值为4</td></tr><tr><td>5-7</td><td></td><td>收到客户端发送过来的消息 以及 挂断，这里revents是对应POLLIN 事件</td></tr><tr><td>8-10</td><td></td><td>尽管client 已经关闭了socket，但是这里还是有 POLLIN 事件产生《=》输入缓冲可读</td></tr></tbody></table><ul><li><p>POLLIN 的含义是 read() 不会阻塞，包括返回0 - 读到EOF</p></li><li><p>EOF 会一直存在于输入缓冲中（不会被读走），read()返回后，由于输入缓冲仍然可读所以如果不关闭socket，仍然会产生POLLIN事件</p></li><li><p>实际发生的事件应该 和 fd中event的设置无关（和要监视的事件无关）</p></li><li><p>HUP 等事件无需设置，只要发生了该事件poll（）就会返回<br> 如果在添加完con socket 后 close(listen_sock)，运行结果：</p></li></ul><div class="language- line-numbers-mode" data-highlighter="shiki" data-ext="" style="--shiki-light:#383A42;--shiki-dark:#abb2bf;--shiki-light-bg:#FAFAFA;--shiki-dark-bg:#282c34;"><pre class="shiki shiki-themes one-light one-dark-pro vp-code"><code class="language-"><span class="line"><span>...</span></span>
<span class="line"><span>Connection established with client, client fd:4</span></span>
<span class="line"><span>Number of events: 1</span></span>
<span class="line"><span>n:0 event:1, revents:20,fd=3</span></span>
<span class="line"><span>accept: Bad file descriptor</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>虽然没有监听POLLNVAL，但是fd集合中包含closed的fd，调用poll（）依然会返回。进行read（）时报错。</p><p>POLLIN | POLLHUP | POLLRDHUP</p><div class="language- line-numbers-mode" data-highlighter="shiki" data-ext="" style="--shiki-light:#383A42;--shiki-dark:#abb2bf;--shiki-light-bg:#FAFAFA;--shiki-dark-bg:#282c34;"><pre class="shiki shiki-themes one-light one-dark-pro vp-code"><code class="language-"><span class="line"><span>Socket created, listen_sock fd:3</span></span>
<span class="line"><span>Number of events: 1</span></span>
<span class="line"><span>n:0 event:1, revents:1,fd=3</span></span>
<span class="line"><span>Connection established with client, client fd:4, ip:192.168.56.101, port:49552</span></span>
<span class="line"><span>Number of events: 1</span></span>
<span class="line"><span>n:1 event:2011, revents:1,fd=4</span></span>
<span class="line"><span>Read 5 bytes from fd:4</span></span>
<span class="line"><span>Number of events: 1</span></span>
<span class="line"><span>n:1 event:2011, revents:2001,fd=4</span></span>
<span class="line"><span>Read 0 bytes from fd:4</span></span>
<span class="line"><span>。。。</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>事件类型：POLLRUHUP(0x2000) | POLLIN(0x001)</p><p>修改客户端代码，不进行shutdown，直接close。监视以上3个情况下的事件。<br> 运行的结果和上面3种情况相同。</p><p>=》即使断开了连接，也不会产生POLLHUP 事件</p><p>在shutdown 和 close 两种情况下都会产生 POLLIN 以及 POLLRDHUP 事件，没办法通过事件判断peer 是 shutdown 还是 close。<br><span style="background:#fff88f;">问：</span>在shutdown 下，client 仍可接收消息，那server 如何区分一个client 是shutdown 还是close？<br> 测试：在read（） 返回0的情况下，向client 发送消息<br> 效果：</p><div class="language- line-numbers-mode has-collapsed-lines collapsed" data-highlighter="shiki" data-ext="" style="--vp-collapsed-lines:15;--shiki-light:#383A42;--shiki-dark:#abb2bf;--shiki-light-bg:#FAFAFA;--shiki-dark-bg:#282c34;"><pre class="shiki shiki-themes one-light one-dark-pro vp-code"><code class="language-"><span class="line"><span>Connection established with client, client fd:4, ip:192.168.56.1, port:5350</span></span>
<span class="line"><span>Number of events: 1</span></span>
<span class="line"><span>n:1 event:2011, revents:1,fd=4</span></span>
<span class="line"><span>Handling event for fd:4</span></span>
<span class="line"><span>Read 3 bytes from fd:4</span></span>
<span class="line"><span>...</span></span>
<span class="line"><span>Number of events: 1</span></span>
<span class="line"><span>n:1 event:2011, revents:2001,fd=4</span></span>
<span class="line"><span>Handling event for fd:4</span></span>
<span class="line"><span>Read 0 bytes from fd:4</span></span>
<span class="line"><span>write to client, result=3</span></span>
<span class="line"><span>...</span></span>
<span class="line"><span>Number of events: 1</span></span>
<span class="line"><span>n:1 event:2011, revents:2019,fd=4</span></span>
<span class="line"><span>Handling event for fd:4</span></span>
<span class="line"><span>Read 0 bytes from fd:4</span></span>
<span class="line"><span>程序终止</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div><div class="collapsed-lines"></div></div><table><thead><tr><th>行号</th><th>功能</th><th>说明</th></tr></thead><tbody><tr><td>7-11</td><td></td><td>POLLRDHUP | POLLIN，对端的输出已经关闭，read（）返回0。write（）仍然被执行 且 结果为写入的字节数。</td></tr><tr><td>13-16</td><td></td><td>由于EOF的存在，poll（）返回，revents： POLLRDHUP | POLLHUP | POLLIN | POLLERR(0x008)，这里产生了POLLHUP 事件，表示socket已经完全关闭了，对一个已经关闭的socke 进行write（）会造成程序终止</td></tr></tbody></table><p><span style="background:#fff88f;">问：</span>为什么在收到POLLRDHUP后仍然可以write？</p><ul><li>socket 带有缓冲（有地方可以写入）</li><li>消息发送给client后，由client的状态确定回复的内容，然后server再确定socket的状态 <ul><li>shutdown：client 正常接收消息</li><li>close：client 回复 Rest，server 收到RST 后将将socket 标记为已断开状态，并产生POLLHUP 事件，此时再向socket 进行write（）就会触发信号，造成程序退出<br> 抓包结果：<br><img src="`+A+'" alt="|398x110" loading="lazy"></li></ul></li></ul><p>Server 收到FIN后再次发送的 【PSH，ACK】包：</p><ul><li>Seq值是1</li><li>通常发送的数据在包尾部，但是这个包不一样：<br><img src="'+c+'" alt="" loading="lazy"><br> 后面的3个字节0x00，对应的是Etherent II 中的Padding<br><img src="'+o+'" alt="" loading="lazy"></li></ul><h3 id="实际应用中" tabindex="-1"><a class="header-anchor" href="#实际应用中"><span>实际应用中</span></a></h3><p>如果需要在peer shutdown 之后进行回复，不用管实际是 close 还是 shutdown 都进行一次write（因为第一次write不会报错，且能够发送给peer），然后关闭socket。</p>',31))])}const b=h(g,[["render",y]]),m=JSON.parse('{"path":"/%E7%BD%91%E7%BB%9C%E7%BC%96%E7%A8%8B/poll.html","title":"poll","lang":"zh-CN","frontmatter":{"category":"网络编程","description":"poll 相关信息 poll() performs a similar task to select(2): it waits for one of a set of file descriptors to become ready to perform I/O. 结构体定义 事件定义 poll.h 关于 POLLHUP 和 POLLRDHUP 的差别...","head":[["script",{"type":"application/ld+json"},"{\\"@context\\":\\"https://schema.org\\",\\"@type\\":\\"Article\\",\\"headline\\":\\"poll\\",\\"image\\":[\\"\\"],\\"dateModified\\":\\"2026-02-05T14:59:02.000Z\\",\\"author\\":[{\\"@type\\":\\"Person\\",\\"name\\":\\"mingStudent\\"}]}"],["meta",{"property":"og:url","content":"https://guzhoutingxue.github.io/%E7%BD%91%E7%BB%9C%E7%BC%96%E7%A8%8B/poll.html"}],["meta",{"property":"og:title","content":"poll"}],["meta",{"property":"og:description","content":"poll 相关信息 poll() performs a similar task to select(2): it waits for one of a set of file descriptors to become ready to perform I/O. 结构体定义 事件定义 poll.h 关于 POLLHUP 和 POLLRDHUP 的差别..."}],["meta",{"property":"og:type","content":"article"}],["meta",{"property":"og:locale","content":"zh-CN"}],["meta",{"property":"og:updated_time","content":"2026-02-05T14:59:02.000Z"}],["meta",{"property":"article:modified_time","content":"2026-02-05T14:59:02.000Z"}]]},"git":{"createdTime":1770303542000,"updatedTime":1770303542000,"contributors":[{"name":"guZhouTingXue","username":"guZhouTingXue","email":"2422173022@qq.com","commits":1,"url":"https://github.com/guZhouTingXue"}]},"readingTime":{"minutes":7.24,"words":2172},"filePathRelative":"网络编程/poll.md","excerpt":"","autoDesc":true}');export{b as comp,m as data};
